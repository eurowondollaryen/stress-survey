/*
ICTSURVEYUSER
*/
CREATE TABLE ICTUSER(
    USER_ID VARCHAR(200) PRIMARY KEY,
    USER_PW VARCHAR(255),
    USER_NAME VARCHAR(255),
    USER_EMAIL VARCHAR(255),
    COMP_ID VARCHAR(255),
    DEPT_NAME VARCHAR(255),
    USER_DIV VARCHAR(1),/*0 : MASTER, 1 : ADMIN, 2 : USER*/
    USER_SEX VARCHAR(1), /* 0 : MALE, 1 : FEMALE */
    INST_TIME VARCHAR(14),
    UPDT_TIME VARCHAR(14)
);
INSERT INTO ICTUSER(USER_ID, USER_PW, USER_NAME, USER_EMAIL, COMP_ID, DEPT_NAME, USER_DIV, USER_SEX, INST_TIME, UPDT_TIME)
VALUES('admin', 'admin##3804', '관리자', 'sehoakasayho@gmail.com', 'K001', 'IT', '0', '0', TO_CHAR(NOW(), 'YYYYMMDDHH24MISS'), NULL);
INSERT INTO ICTUSER(USER_ID, USER_PW, USER_NAME, USER_EMAIL, COMP_ID, DEPT_NAME, USER_DIV, USER_SEX, INST_TIME, UPDT_TIME)
VALUES('test', 'test##3804', '테스트사용자', 'sehoakasayho@naver.com', 'K001', 'IT', '1', '0', TO_CHAR(NOW(), 'YYYYMMDDHH24MISS'), NULL);

CREATE TABLE ICTCOMPANY(
    COMPANY_ID VARCHAR(10) PRIMARY KEY,
    COMPANY_NAME VARCHAR(255),
    COMPANY_NAME_1 VARCHAR(255),
    DTL_NOTE VARCHAR(255),
    INST_TIME VARCHAR(14),
    UPDT_TIME VARCHAR(14)
);
INSERT INTO ICTCOMPANY(COMPANY_ID, COMPANY_NAME, COMPANY_NAME_1, DTL_NOTE, INST_TIME, UPDT_TIME)
VALUES('K001', 'KTR', '한국화학융합시험연구원', 'test data', TO_CHAR(NOW(), 'YYYYMMDDHH24MISS'), NULL);
INSERT INTO ICTCOMPANY(COMPANY_ID, COMPANY_NAME, COMPANY_NAME_1, DTL_NOTE, INST_TIME, UPDT_TIME)
VALUES('K002', 'KCL', '한국건설생활환경시험연구원', 'test Sㄱㄴㅇdata', TO_CHAR(NOW(), 'YYYYMMDDHH24MISS'), NULL);


/* 설문 마스터 & 디테일 */
CREATE TABLE ICTSURVEYXM(
    SRVY_ID VARCHAR(10) PRIMARY KEY,
    SRVY_TITL VARCHAR(100),
    DTL_NOTE VARCHAR(255),
    INST_TIME VARCHAR(14),
    UPDT_TIME VARCHAR(14)
);

INSERT INTO ICTSURVEYXM
VALUES('2021060001', '테스트 설문1', '테스트설문입니다.1', TO_CHAR(NOW(), 'YYYYMMDDHH24MISS'));
INSERT INTO ICTSURVEYXM
VALUES('2021060002', '테스트 설문2', '테스트설문입니다2.', TO_CHAR(NOW(), 'YYYYMMDDHH24MISS'));

/* 디테일은 설문 내용 및 가중치를 보고 설계 완성시키기 */
CREATE TABLE ICTSURVEYXD(
    SRVY_ID VARCHAR(10),
    QSTN_SEQ INTEGER,
    QSTN_TITL VARCHAR(255), /* 질의 제목*/
    QSTN_OPTN_1 VARCHAR(255), /* 선택값 1 */
    QSTN_OPTN_2 VARCHAR(255), /* 선택값 2 */
    QSTN_OPTN_3 VARCHAR(255), /* 선택값 3 */
    QSTN_OPTN_4 VARCHAR(255), /* 선택값 4 */
    DTL_NOTE VARCHAR(255), /* 비고 */
    INST_TIME VARCHAR(14),
    UPDT_TIME VARCHAR(14),
    PRIMARY KEY (SRVY_ID, QSTN_SEQ) /* POSTGRESQL에서는 PK를 이렇게 설정 */
);

/* SURROGATE KEY 생성 FUNCTION */
CREATE OR REPLACE FUNCTION SURROGATE_NEXTVAL(iMAX_VALUE VARCHAR)
RETURNS VARCHAR
LANGUAGE PLPGSQL
AS
$$
DECLARE
    HEADER VARCHAR;
    TAIL VARCHAR;
    RESULT VARCHAR;
BEGIN
    HEADER := SUBSTR(iMAX_VALUE,1,6);
    TAIL := SUBSTR(iMAX_VALUE,7,4);
    RESULT := TO_CHAR(NOW(), 'YYYYMM');

    IF TO_CHAR(NOW(), 'YYYYMM') = HEADER THEN
        RESULT := CONCAT(RESULT, LPAD(CAST(CAST(TAIL AS INTEGER) + 1 AS VARCHAR), 4, '0'));
    ELSE
        RESULT := CONCAT(RESULT, '0001');
    END IF;

    RETURN RESULT;
END;
$$;

/* 코드값 관리 마스터 테이블 */
CREATE TABLE COMCODEXM (
    COMM_CODE VARCHAR(25) PRIMARY KEY, /* 공통코드명 */
    CODE_NOTE VARCHAR(255), /* 공통코드 설명 */
    INST_TIME VARCHAR(14),
    UPDT_TIME VARCHAR(14)
);

INSERT INTO COMCODEXM(CODE_NAME, CODE_NOTE, INST_TIME)
VALUES ('COMPANY_CODE', '회사코드', TO_CHAR(NOW(), 'YYYYMMDDHH24MISS'));

/* 코드값 관리 디테일 테이블 */
CREATE TABLE COMCODEXD (
    COMM_CODE VARCHAR(25), /* 공통코드명 */
    COMM_NAME VARCHAR(25), /* 코드값(key) */
    CODE_VAL VARCHAR(255), /* 코드명칭(value) */
    INST_TIME VARCHAR(14),
    UPDT_TIME VARCHAR(14)
);